# Data Persistence

The system uses a dual-persistence strategy: **Convex** for dynamic game state and **Filesystem** for heavy static assets.

## 1. Convex (Database)

**File**: `convex/schema.ts`

Convex is the source of truth for the *active* game session. It stores the lightweight JSON state that changes frequently.

### Schema Definition
```typescript
{
    games: defineTable({
        // The master state object. Contains entities, turn counts, meta info.
        state: v.any(), 
        
        // Natural language rules generated by the LLM.
        rules: v.string(), 
        
        // Current status of the game session.
        isActive: v.boolean(),
        
        // Link to the backend filesystem artifacts (runs directory).
        runId: v.optional(v.string()),

        // Engine Configuration & Status
        engine_tools: v.optional(v.any()), // Dynamic tool definitions
        engine_logic: v.optional(v.string()), // Dynamic logic guide
        status: v.string(), // "idle" | "generating" | "playing" | "failed"
        progress: v.optional(v.string()) // e.g., "Generating Sprites..."
    }),
    
    messages: defineTable({
        gameId: v.id("games"),
        role: v.string(), // "user", "agent", "system"
        content: v.string(), // Chat log
        timestamp: v.number(),
    }).index("by_gameId", ["gameId"])
}
```

### Usage
*   **Queries**: `api.games.get` (Frontend polling/subscription).
*   **Mutations**: `api.games.updateState` (Called by Server Actions mechanism).

## 2. Filesystem (Artifacts)

**Location**: `backend/data/runs/{runId}/`

Heavy assets generated during the creation phase are stored as static files. This avoids bloating the database.

| File              | Description               | Usage                                        |
| :---------------- | :------------------------ | :------------------------------------------- |
| `scene.png`       | Original full generation  | Debugging                                    |
| `background.png`  | Clean background plate    | Frontend (`<SmartScene>`)                    |
| `sprites.png`     | Isolated Foreground       | Debugging                                    |
| `extracted/*.png` | Individual Entity Sprites | Frontend (`Entity.src`)                      |
| `navmesh.json`    | Walkable zones data       | Frontend (Debug overlay) & Backend (Referee) |
| `analysis.json`   | Vision analysis data      | Backend (Initial State Gen)                  |
| `gamestate.json`  | Initial State Snapshot    | Backend (Restoring State)                    |

### Asset Proxy
The frontend accesses these files via a Next.js API route that serves files from the local filesystem:
*   Route: `/api/asset-proxy/[runId]/[filename]`
